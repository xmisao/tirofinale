#!/usr/bin/env ruby
require 'open-uri'
require 'optparse'
require 'pp'

def detect_version_alpine
  content = open('/etc/alpine-release'){|f| f.read }
  major_minor = content.match(/\A(\d\.\d)/)
  major_minor ? major_minor[1] : nil
end

def search_apkbuild(gem_name, alpine_version)
  dir_list = ['community', 'main', 'non-free', 'testing', 'unmaintained']
  dir_list.each{|dir_name|
    apkbuild_url = "http://git.alpinelinux.org/cgit/aports/plain/#{dir_name}/ruby-#{gem_name}/APKBUILD?h=#{alpine_version + '-stable'}"
    begin
      return open(apkbuild_url){|f| f.read}
    rescue OpenURI::HTTPError => e
      next
    end
  }
  false
end

def extract_makedepends(apkbuild)
  variables = []

  apkbuild.each_line{|l|
    if m = l.match(/^([^\s]+)=(.*)$/)
      key = m[1]
      value = m[2]

      variables << {:key => key, :value => value}
    end
  }

  variables.sort_by!{|var| var[:key].length * -1}

  variables.each{|var|
    if m = var[:value].match(/^"(.*)"$/)
      var[:value] = m[1]
    end
  }

  variables.each{|var|
    while var[:value].include?('$')
      result = nil
      variables.each{|var2|
        result = result || var[:value].gsub!("$#{var2[:key]}", var2[:value])
      }
      break unless result
    end
  }

  variables.select{|var| var[:key] == 'makedepends'}.first[:value]
end

alpine_version = nil
gem_name = nil

op = OptionParser.new
op.on('--dist-version VERSION'){|val| alpine_version = val}
op.on('--gem GEM_NAME'){|val| gem_name = val}
op.parse(ARGV)

alpine_version ||= detect_version_alpine()

apkbuild = search_apkbuild(gem_name, alpine_version)

makedepends = extract_makedepends(apkbuild)

packages = makedepends.strip.split(' ')

print packages.join(' ')
